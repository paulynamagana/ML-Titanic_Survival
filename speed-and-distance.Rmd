---
title: "speed-and-distance"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
```

## Survival on the Titanic

### Load packages

```{r, message=FALSE}
library("dplyr")
library("ggplot2") #visualization
library("randomForest") #predict
library("skimr") #skim data
library("tidyverse")
library("scales") #dollar scale
library("mice") #predcit
theme_set(theme_classic())
```

### Load data

```{r}
train <- read.csv("train.csv", stringsAsFactors = F, na.strings=c("", "NA"))
test <- read.csv("test.csv", na.strings=c("", "NA"))
full<- bind_rows(train,test) #bind training& test data
```

### Take a look at the data

```{r}

skim(full) %>% 
  select(-(numeric.p0:numeric.p100)) %>%
  select(-(complete_rate))

str(full)
```


### Understand the data

| Variable | Description |
|:----------|:---------------------------|
|Survived	| Survived (1) or died (0) |
|Pclass	| Passenger’s class, 1 = 1st, 2 = 2nd, 3 = 3rd |
|Name	| Passenger’s name |
|Sex	| Passenger’s sex |
|Age	| Passenger’s age |
|SibSp	| Number of siblings/spouses aboard |
|Parch	| Number of parents/children aboard |
|Ticket	| Ticket number |
|Fare	| Fare |
|Cabin	| Cabin |
|Embarked	|	Port of embarkation, C = Cherbourg, Q = Queenstown, S = Southampton |

## Data Cleaning

Let's organize the data. We can break down into additional meaningful variables. Passenger title is contained within the passenger name variable ad we can use the surname to represent families.

```{r}
#Grab title from passenger names
full$Title <- gsub('(.*, )|(\\..*)', '', full$Name)

#Show title couns by sex
knitr::kable(table(full$Sex, full$Title))
```


```{r}
#Let's get rid of those titles with low cell counts to be combined
rare_title <- c('Capt', 'Col', 'the Countess','Don', 'Dona', 'Dr', 
                'Lady', 'Major', 'Rev', 'Sir', 'Jonkheer')

# Also reassign mlle, ms, and mme accordingly
full$Title[full$Title == 'Mlle']        <- 'Miss' 
full$Title[full$Title == 'Ms']          <- 'Miss'
full$Title[full$Title == 'Mme']         <- 'Mrs' 
full$Title[full$Title %in% rare_title]  <- 'Rare Title'

# Show title counts by sex again
knitr::kable(table(full$Sex, full$Title))
```

```{r}
#Grab surname

full$Surname <- sapply(full$Name,  
                      function(x) strsplit(x, split = '[,.]')[[1]][1])

cat(paste("There are <b>", nlevels(factor(full$Surname)), "</b> unique surnames"))
```

Now that we’ve taken care of splitting passenger name into some new variables, we can take it a step further and make some new family variables. First we’re going to make a family size variable based on number of siblings/spouse(s) (maybe someone has more than one spouse?) and number of children/parents.

```{r}
#Create a family size variable
full$Fsize <- full$SibSp + full$Parch + 1

#create a family variable
full$Family <- paste(full$Surname, full$Fsize, sep = "_")
```

Let's look at the family size variable and understand how it may relate to survival

```{r}
#ggplot2 to visualize
ggplot(full[1:891,], aes(x=Fsize, fill= factor(Survived))) +
  geom_bar(stat="count", position="dodge") +
  scale_x_continuous(breaks=c(1:11)) +
  labs(x="Family Size") 
```

There’s a survival penalty to singletons and those with family sizes above 4. We can collapse this variable into three levels which will be helpful since there are comparatively fewer large families. Let’s create a discretized family size variable.

```{r}
#Discrete family size
full$FsizeD[full$Fsize == 1] <- "single"
full$FsizeD[full$Fsize < 5 & full$Fsize >1] <- "small"
full$FsizeD[full$Fsize > 4] <- "large"

#Let's visualize depending on Family Size
mosaicplot(table(full$FsizeD, full$Survived), main= "Family Size by Survival", shade=TRUE)
```

There's a survival penalty among single and large families, but a benefit for passenger in small families, remember Survived (1) or died (0).

### Let's treat a few more variables

#### Passenger Cabin

Let's see if they were in first class or not.

```{r}
head(full$Cabin)
```
```{r}
# The first character is the deck. For example:
strsplit(full$Cabin[2], NULL)[[1]]
```

```{r}
# Create a Deck variable. Get passenger deck A - F:
full$Deck<-factor(sapply(full$Cabin, function(x) strsplit(x, NULL)[[1]][1]))
```

### Missingness

Now we’re ready to start exploring missing data and rectifying it through imputation. There are a number of different ways we could go about doing this. Given the small size of the dataset, we probably should not opt for deleting either entire observations (rows) or variables (columns) containing missing values. We’re left with the option of either replacing missing values with a sensible values given the distribution of the data, e.g., the mean, median or mode. Finally, we could go with prediction. We’ll use both of the two latter methods and I’ll rely on some data visualization to guide our decisions.


```{r}
skim(full) %>% 
  select(-(numeric.p0:numeric.p100)) %>%
  select(-(complete_rate)) 
```

Let's look at those 2 empty rows on Embarked

```{r}
knitr::kable(filter(full, is.na(Embarked)))
```
```{r}
cat(paste('We will infer their values for **embarkment** based on present data that we can imagine may be relevant: **passenger class** and **fare**. We see that they paid<b> $', full[c(62, 830), 'Fare'][[1]][1], '</b>and<b> $', full[c(62, 830), 'Fare'][[1]][2], '</b>respectively and their classes are<b>', full[c(62, 830), 'Pclass'][[1]][1], '</b>and<b>', full[c(62, 830), 'Pclass'][[1]][2], '</b>. So from where did they embark?'))
```

```{r}
# Get rid of our missing passenger IDs
embark_fare <- full %>%
  filter(PassengerId != 62 & PassengerId != 830)

#Visualize
ggplot(embark_fare, aes(x=Embarked, y=Fare, fill = factor(Pclass))) +
  geom_boxplot()+
  geom_hline(aes(yintercept=80),
             colour= "red", linetype="dashed") + #80 is the fare we got 
  scale_y_continuous(labels = dollar_format()) +
  scale_x_discrete(labels = c("Cherbourg", "Queenstown", "Southampton"))
```

So the median fare for a first class passenger departing from Charbourg coincides nicely with the $80 paid by our embarkment-deficient passengers!!! I think we can safely replace the NA values with ‘C’.

```{r}
# Since their fare was $80 for 1st class, they most likely embarked from 'C'
full$Embarked[c(62, 830)] <- 'C'
```

#### Now let's take a look at the missing value on Fare

```{r}
knitr::kable(filter(full, is.na(Fare)))
```

This is a third class passenger who departed from Southampton (‘S’). Let’s visualize Fares among all others sharing their class (3) and embarkment (S) (n = 494).

```{r}
ggplot(full[full$Pclass == "3" & full$Embarked == "S", ], 
  aes(x=Fare)) +
  geom_density(fill="lightblue") +
  geom_vline(aes(xintercept=median(Fare, na.rm=T)),
             colour="red", linetype="dashed") +
  scale_x_continuous(labels=dollar_format())
```

From this visualization, it seems quite reasonable to replace the NA Fare value with median for their class and embarkment.

```{r}
#Replace missing fare value with median fare for class/embarkment
full$Fare[1044] <- median(full[full$Pclass == "3" & full$Embarked == "S",]$Fare, na.rm = TRUE)

#Let's take a look
full$Fare[1044]
```

#### Ages

There are quite a few missing Age values in our data.
We will create a model predicting ages based on other variables.

```{r}

# Make variables factors into factors
factor_vars <- c('PassengerId','Pclass','Sex','Embarked',
                 'Title','Surname','Family','FsizeD')

full[factor_vars] <- lapply(full[factor_vars], function(x) as.factor(x))

# Set a random seed
set.seed(129)

# Perform mice imputation, excluding certain less-than-useful variables:
mice_mod <- mice(full[, !names(full) %in% c('PassengerId','Name','Ticket','Cabin','Family','Surname','Survived')], method='rf') 

# Save the complete output 
mice_output <- complete(mice_mod)
```
Let’s compare the results we get with the original distribution of passenger ages to ensure that nothing has gone completely awry.

```{r}
# Plot age distributions
par(mfrow=c(1,2))
hist(full$Age, freq=F, main='Age: Original Data', 
  col='darkgreen', ylim=c(0,0.04))
hist(mice_output$Age, freq=F, main='Age: MICE Output', 
  col='lightgreen', ylim=c(0,0.04))
```
Let’s replace our age vector in the original data with the output from the mice model.
 
```{r}
# Replace Age variable from the mice model.
full$Age <- mice_output$Age

# Show new number of missing Age values
sum(is.na(full$Age))
```

```{r}
# First we'll look at the relationship between age & survival
ggplot(full[1:891,], aes(Age, fill = factor(Survived))) + 
  geom_histogram() + 
  # I include Sex since we know (a priori) it's a significant predictor
  facet_grid(.~Sex) 
```

```{r}
# Create the column child, and indicate whether child or adult
full$Child[full$Age < 18] <- 'Child'
full$Child[full$Age >= 18] <- 'Adult'

# Show counts
knitr::kable(table(full$Child, full$Survived))
```

Yeah, looks like being a child won't necessarily save you!
Maybe we can hope that mothers are more likely to have survived on the Titanic.

```{r}
# Adding Mother variable
full$Mother <- 'Not Mother'
full$Mother[full$Sex == 'female' & full$Parch > 0 & full$Age > 18 & full$Title != 'Miss'] <- 'Mother'

# Show counts
knitr::kable(table(full$Mother, full$Survived))

# Finish by factorizing our two new factor variables
full$Child  <- factor(full$Child)
full$Mother <- factor(full$Mother)

# First we'll look at the relationship between age & survival
ggplot(full[1:891,], aes(Mother, fill = factor(Survived))) + 
  geom_bar() 

```

Is there more missing data?
```{r}
knitr::kable(md.pattern(full))
skim(full)%>% 
  select(-(numeric.p0:numeric.p100)) %>%
  select(-(complete_rate))
```
## Data Visualisation! {.tabset .tabset-fade}

### Pclass 
```{r rate_pclass, message=FALSE, warning=FALSE, echo=TRUE, fig.height=4.5, fig.width=9}
ggplot(full[1:891,], aes(Pclass, fill=factor(Survived))) +
  geom_bar(position="fill") +
  scale_y_continuous(labels = percent) +
  labs(y="Survival Rate", title="Survival Rate by Class") +
  scale_x_discrete(labels= c("1st", "2nd", "3rd")) 

```


### Age 
```{r age, message=FALSE, warning=FALSE, echo=TRUE, fig.height=4.5, fig.width=9}
ggplot(full[1:891,], aes(Age, fill=factor(Survived))) +
  geom_histogram(aes(y=..count..), alpha=0.5) +
  labs(y="Density", title="Survival by Age") 
```
### Siblings 
```{r siblings, message=FALSE, warning=FALSE, echo=TRUE, fig.height=4.5, fig.width=9}
ggplot(full[1:891,], aes(SibSp, fill=factor(Survived))) +
  geom_bar(position="stack") +
  labs(y="Passengers", title="Survival by SibSp") 
```

### Embarkment

```{r embarkment, message=FALSE, warning=FALSE, echo=TRUE, fig.height=4.5, fig.width=9}
ggplot(full[1:891,], aes(Embarked, fill=factor(Survived))) +
  geom_bar(position="stack") +
  labs(y="Passengers", title="Survival by Embarked") +
  scale_x_discrete(labels= c("Cherbourg", "Queenstown", "Southampton")) 
```
### Title

```{r title, message=FALSE, warning=FALSE, echo=TRUE, fig.height=4.5, fig.width=9}
ggplot(full[1:891,], aes(Title, fill=factor(Survived))) +
  geom_bar(position="stack") +
  labs(y="Passengers", title="Survival by Title") 
```

### Family Size

```{r familysize, message=FALSE, warning=FALSE, echo=TRUE, fig.height=4.5, fig.width=9}
ggplot(full[1:891,], aes(FsizeD, fill=factor(Survived))) +
  geom_bar(position="stack") +
  labs(y="Passengers", title="Survival by Family Size") 
```


###{-}

## Prediction time

We are now ready to predict!

```{r}
# Split the data back into a train set and a test set
train <- full[1:891,]
test <- full[892:1309,]
```


#### Building the model
```{r}
# Set a random seed
set.seed(129)

#Build a model with Pclass, sex, age, SibSp, parch, fare, embarked, title, FsizeD, Child, Mother, 
rf_model <- randomForest(factor(Survived) ~ Pclass + Sex + Age + SibSp + Parch + 
                                            Fare + Embarked + Title + 
                                            FsizeD + Child + Mother,
                                            data = train)

# Show model error
plot(rf_model, ylim=c(0,0.36))
legend('topright', colnames(rf_model$err.rate), col=1:3, fill=1:3)
```

The black line shows the overall error rate which falls below 20%. The red and green lines show the error rate for ‘died’ and ‘survived’ respectively. We can see that right now we’re much more successful predicting death than we are survival.

#### Variable importance

```{r}
# Get importance
importance    <- importance(rf_model)
varImportance <- data.frame(Variables = row.names(importance), 
                            Importance = round(importance[ ,'MeanDecreaseGini'],2))

# Create a rank variable based on importance
rankImportance <- varImportance %>%
  mutate(Rank = paste0('#',dense_rank(desc(Importance))))

# Use ggplot2 to visualize the relative importance of variables
ggplot(rankImportance, aes(x = reorder(Variables, Importance), 
    y = Importance, fill = Importance)) +
  geom_bar(stat='identity') + 
  geom_text(aes(x = Variables, y = 0.5, label = Rank),
    hjust=0, vjust=0.55, size = 4, colour = 'red') +
  labs(x = 'Variables') +
  coord_flip()
```


## Predict again

#### Predict depending on title

```{r}

#Build a second model with Pclass, sex, age, SibSp, parch, fare, embarked, title, FsizeD, Child, Mother, 
rf_model2<- randomForest(factor(Survived) ~ Title + Fare + Sex + Age + Pclass,
                                            data = train)

# Show model error
plot(rf_model2, ylim=c(0,0.4))
legend('topright', colnames(rf_model2$err.rate), col=1:3, fill=1:3)

# Predict using the test set
prediction <- predict(rf_model2, test)


# Save the solution to a dataframe with two columns: PassengerId and Survived (prediction)
solution <- data.frame(PassengerID = test$PassengerId, Survived = prediction)
head(solution)

ggplot(solution, aes(Survived))+
  geom_bar()

# Write the solution to file
write.csv(solution, file = 'rf_mod_Solution.csv', row.names = F)

sessionInfo()
```